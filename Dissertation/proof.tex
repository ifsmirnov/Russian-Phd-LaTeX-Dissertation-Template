\begin{theorem}[о корректности и асимптотике {\CH[r]}] \label{th:fast-correct-r}
Для любого натурального $r > 1$, для любой последовательности из
$n$ операций \textbf{insert} и $k$ операций \textbf{extractMin},
в которой запрос \textbf{extractMin} может поступать только к непустой
куче, верно следующее:
\begin{enumerate}
\item (корректность) каждая операция \textbf{extractMin} удаляет минимальный элемент
из находящихся в куче к тому моменту;
\item (асимптотика) каждая операция \textbf{insert} требует $O(r)$ сравнений,
каждая операция \textbf{extractMin} требует $O(\log^{(r)} n + r(\log k + \log r))$ сравнений,
где $k$ "--- количество вызовов \textbf{extractMin} к тому моменту, причём
обе оценки верны в худшем случае.
\end{enumerate}
\end{theorem}

\begin{theorem}[о корректности и асимптотике {\CH[*]}] \label{th:fast-correct-*}
Для любой последовательности из
$n$ операций \textbf{insert} и $k$ операций \textbf{extractMin},
в которой запрос \textbf{extractMin} может поступать только к непустой
куче, верно следующее:
\begin{enumerate}
\item (корректность) каждая операция \textbf{extractMin} удаляет минимальный элемент
из находящихся в куче к тому моменту;
\item (асимптотика) каждая операция \textbf{insert} требует $O(\log^* n)$ сравнений,
каждая операция \textbf{extractMin} требует $O(\log^* n(\log k + \log \log^* n))$ сравнений,
где $k$ "--- количество вызовов \textbf{extractMin} к тому моменту, причём
обе оценки верны в худшем случае.
\end{enumerate}
\end{theorem}

\bigskip

Как и в секции \ref{ch:proof-simple}, для доказательства этих двух теорем
будет сформулировано и доказано несколько лемм. Если явно не сказано иное,
каждая лемма относится как и к \CH[r], так и к \CH[*]. Все леммы и теоремы,
в которых фигурирует буфер, относятся только к \CH[r]. Во всех доказательствах
параметр $r$ считается произвольным положительным натуральным числом.

\begin{remark}
Если явно не сказано иное, под записью $\log x$ подразумевается
двоичный логарифм ($\log_2 x$). То же самое относится к повторному
логарифму ($\log^{(r)} x$) и к итеративному ($\log^* x$).
\end{remark}

\begin{lem} \label{th:mh-few-elements}
Пусть в \MH[t] для некоторого $t$ переполнилась в некоторый
момент времени. Тогда для любого $b \geq 0$ после $b$
вставок $|\MH[t]| \leq b + 1$.
\end{lem}
\begin{proof}
Сначала заметим, что операция \textbf{extractMin}
может только уменьшить
количество элементов в \MH[t].

Элементы могут попасть в \MH[t] двумя способами:
\begin{enumerate}
\item в результате переполнения \MH[t] в неё попадает
куча, отложенно вставляемая в \MH[t];
\item в \MH[t] добавляется новый элемент в результате
завершившейся балансировки на уровне $t-1$.
\end{enumerate}

После события первого типа $|\MH[t]| = 1$. Событие второго
типа может произойти не чаще, чем один раз на вставку, потому
что две балансировки не могут идти одновременно \todo{теорема
об этом, вообще говоря, пользуется этой леммой, так что по-честному
нужна индукция по уровню}. Значит, при увеличении $b$ на $1$
в \MH[t] попадает не более одного элемента, что и доказывает
лемму.
\end{proof}

\begin{lem} \label{th:mh-exp-growth}
Пусть на $t$-м уровне ($t > 0$) произошло переполнение кучи \MH[t]
после $n$ вставок, и следующее переполнение на этом уровне
произойдёт после $n' = n + b$ вставок для некоторого $b$,
если за это время не произойдёт вызова \textbf{extractMin}.
Тогда $|\MH[t+1]| \leq 2^b$.
\end{lem}
\begin{proof}[Доказательство для {\CH[r]}]\belowdisplayskip=-14pt
Обозначим $s = \log^{(r-t+1)} n$. Из условий на переполнение имеем:
\begin{gather*}
b > \log^{(r-t)} (n + b) \mathrm{\quad по\ лемме\ \ref{th:mh-few-elements}} \\
b > \log^{(r-t)} n = \log s \\
2^b > s \\
|\MH[t+1]| \leq \log^{(r+t-1)} n = s \mathrm{\quad из\ условий\ переполнения} \\
|\MH[t+1]| < 2^b
\end{gather*}
\end{proof}

\begin{proof}[Доказательство для {\CH[*]}]\belowdisplayskip=-14pt
\begin{gather*}
b \geq {}^t 2 \mathrm{\quad по\ лемме\ \ref{th:mh-few-elements}} \\
2^b \geq {}^{t+1} 2 \\
|\MH[t+1]| \leq {}^{t+1} 2\mathrm{\quad из\ условий\ переполнения} \\
|\MH[t+1]| \leq 2^b
\end{gather*}
\end{proof}
